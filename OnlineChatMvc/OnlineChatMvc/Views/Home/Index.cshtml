@model List<Message>
@{
    ViewData["Title"] = "Home Page";
}

<div class="text-left">
    <h1 class="display-4">Привет в чате.</h1>
    @if(!User.Identity.IsAuthenticated)
    {
       <form action="/Home/Login" method="post">
            <div class="mb-3">
                <label class="form-label">Ваше имя</label>
                <input type="text" name="name" class="form-control" />
            </div>
            <button type="submit" class="btn btn-primary">Войти</button>
        </form>

        <div id="inputForm">
            <input type="text" id="message" />
            <input type="button" id="sendBtn" value="Отправить" />
        </div>

       
    }
    else
    {
        <div id="inputForm">
            <input type="text" id="message" />
            <input type="button" id="sendBtn" value="Отправить" />
        </div>

        <script>
            document.getElementById("sendBtn").addEventListener("click", function () {
                let message = document.getElementById("message").value;
                hubConnection.invoke("Send", message)
                    .catch(function (err) {
                        return console.error(err.toString());
                    });
            });
        </script>
    }



   
    <div id="chatroom">
@foreach(var message in Model)
        {
            <p>@message.Data.ToString("dd.MM HH:mm") <i>@message.User.Name</i> <br /> @message.Text</p>
        }

    </div>
</div>

<script>

    const hubConnection = new signalR.HubConnectionBuilder()
        .withUrl("/chat")
        .build();

    hubConnection.on("Receive", function (username, date, message) {

        let messageElement = document.createElement("p");
        messageElement.innerHTML = date + " <i>" + username + "</i> <br / >" + message;
        document.getElementById("chatroom").prepend(messageElement);
    });


    hubConnection.start()
        .then(function () {
           if(document.getElementById("SendBtn")) document.getElementById("sendBtn").disabled = false;
           console.log("Поключение успешно")

        })
        .catch(function (err) {
            return console.error(err.toString());
        });

</script>